<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DLX/DMT - Dispatch Console</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">

  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    .msg-sent { background:#4f46e5; color:#fff; border-radius:18px 18px 4px 18px; }
    .msg-received { background:#f1f5f9; color:#1e293b; border-radius:18px 18px 18px 4px; }
    
    .fade-in-up { animation: fadeInUp 0.2s ease-out forwards; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(4px);} to { opacity:1; transform:translateY(0);} }
  </style>
</head>

<body class="bg-slate-50 h-screen flex overflow-hidden text-slate-800">

  <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

  <aside class="w-full md:w-80 bg-white border-r border-slate-200 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300 transform" id="sidebar">
    <div class="h-16 px-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
      <div class="flex items-center gap-2 text-indigo-600 font-bold text-lg tracking-tight">
        <i class="fa-solid fa-comments"></i>
        <span>DLX/DMT</span>
      </div>
      <div class="flex gap-1">
        <button onclick="window.openContactsManager()" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition" title="Contacts Manager"><i class="fa-solid fa-address-book"></i></button>

        <button onclick="window.openMergerModal()" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition" title="1. Merge Data"><i class="fa-solid fa-file-export"></i></button>
        <button onclick="document.getElementById('broadcastCsvInput').click()" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition" title="2. Broadcast"><i class="fa-solid fa-bullhorn"></i></button>
        <input type="file" id="broadcastCsvInput" accept=".csv" class="hidden" onchange="window.handleBroadcastCsv(this)">
        <button onclick="window.openAssignmentsModal()" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition" title="3. Assign Trips"><i class="fa-solid fa-route"></i></button>

        <button onclick="window.openNewMsgModal()" class="w-8 h-8 flex items-center justify-center bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg transition shadow-sm ml-1" title="New Msg"><i class="fa-solid fa-pen"></i></button>
      </div>
    </div>

    <div class="p-3 border-b border-slate-100 space-y-2 bg-slate-50/50">
      <div class="relative">
        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
        <input type="text" id="searchContacts" onkeyup="window.renderThreadList()" placeholder="Search..." class="w-full bg-white border border-slate-200 text-sm pl-9 pr-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
      </div>
      <div class="flex items-center gap-2">
        <button onclick="window.toggleUnreadOnly()" id="unreadOnlyBtn" class="flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide border transition border-slate-200 text-slate-600 hover:bg-white hover:shadow-sm">Unread</button>
        <button onclick="window.openMergePurge()" class="flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide border transition border-slate-200 text-slate-600 hover:bg-white hover:shadow-sm">Tools</button>
        <button onclick="window.togglePinnedOnly()" id="pinnedOnlyBtn" class="flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide border transition border-slate-200 text-slate-600 hover:bg-white hover:shadow-sm">Pinned</button>
      </div>
      <div id="tagChips" class="flex flex-wrap gap-1.5 pt-1"></div>
      <div class="flex justify-between items-center text-[10px] text-slate-400 pt-1">
        <span>DB: <span class="font-mono text-slate-500">dispatch_main</span></span>
        <button onclick="document.getElementById('csvInput').click()" class="hover:text-indigo-600">Import CSV</button>
        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="window.handleCsvUpload(this)">
      </div>
    </div>

    <div class="flex-1 overflow-y-auto" id="contactList"></div>

    <div class="p-3 bg-slate-50 border-t border-slate-200 flex items-center gap-3">
      <div id="userAvatar" class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-xs font-bold shadow-sm">D</div>
      <div class="flex-1 overflow-hidden">
        <div class="text-xs font-bold text-slate-700 truncate">Dispatch Team</div>
        <div class="text-[10px] text-slate-400 truncate">Online</div>
      </div>
      <button onclick="window.resetLocalUI()" class="text-slate-400 hover:text-red-500 transition" title="Reset View"><i class="fa-solid fa-rotate-left"></i></button>
    </div>
  </aside>

  <main class="flex-1 flex flex-col bg-white relative w-full">
    <div id="mobileOverlay" onclick="window.toggleMobileSidebar()" class="absolute inset-0 bg-black/20 z-10 hidden md:hidden"></div>

    <header class="h-16 px-4 border-b border-slate-100 flex items-center justify-between bg-white flex-shrink-0">
      <div class="flex items-center gap-3 min-w-0">
        <button onclick="window.toggleMobileSidebar()" class="md:hidden text-slate-500 hover:text-indigo-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
        <div id="activeContactAvatar" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-sm border border-slate-200">?</div>
        <div class="min-w-0">
          <h2 id="activeContactName" class="font-bold text-slate-800 text-sm truncate">Select a conversation</h2>
          <div class="flex items-center gap-2 min-w-0">
            <p id="activeContactPhone" class="text-xs text-slate-400 truncate">+1 ...</p>
            <div id="activeTags" class="flex flex-wrap gap-1"></div>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-4 text-slate-400">
<button onclick="window.openThreadSearch()" class="hover:text-indigo-600 transition" title="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
<button onclick="window.exportActiveThreadCsv()" class="hover:text-indigo-600 transition" title="Export CSV"><i class="fa-solid fa-file-csv"></i></button>

<button onclick="window.deleteActiveThread()" class="hover:text-red-500 transition" title="Delete Thread"><i class="fa-solid fa-trash"></i></button>

<button onclick="window.openSettingsModal()" class="hover:text-indigo-600 transition" title="Settings"><i class="fa-solid fa-gear"></i></button>
        <button onclick="window.openThreadInfo()" class="hover:text-indigo-600 transition" title="Info"><i class="fa-solid fa-circle-info"></i></button>
        
      </div>
    </header>

    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30 relative">
      <div id="welcomeState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300">
        <i class="fa-regular fa-comments text-6xl mb-4 opacity-50"></i>
        <p class="font-medium">Select a contact to start messaging</p>
      </div>
      <div id="messageList" class="space-y-4 pb-2"></div>
    </div>

    <div class="p-4 bg-white border-t border-slate-100 flex-shrink-0">
      <div class="max-w-4xl mx-auto flex flex-col gap-2">
        <div id="quickRepliesRow" class="flex flex-wrap gap-2"></div>
        <div class="relative flex items-end gap-2">
          <div class="relative flex-1">
            <textarea id="msgInput" rows="1" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition resize-none max-h-48 shadow-sm" placeholder="Type a message..."></textarea>
          </div>
          
          <input type="file" id="mmsFileInput" class="hidden" multiple accept="image/*,video/*,audio/*,application/pdf" onchange="window.handleMmsFiles(this)">
          <button onclick="document.getElementById('mmsFileInput').click()" id="attachBtn" class="p-3 bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200 transition shadow-sm flex-shrink-0" title="Attach (MMS)">
            <i class="fa-solid fa-paperclip"></i>
          </button>
          <div id="mmsPreviewPill" class="hidden px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-xs border border-indigo-100 flex items-center gap-2">
            <i class="fa-solid fa-images"></i>
            <span id="mmsPreviewCount">0</span>
            <button onclick="window.clearMmsQueue()" class="text-indigo-500 hover:text-indigo-700" title="Clear">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <button onclick="window.sendMessage()" id="sendBtn" class="p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition shadow-md flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
        <div class="text-[10px] text-slate-400 flex items-center justify-between px-2">
          <span>Enter = send â€¢ Shift+Enter = newline</span>
          <span id="draftHint" class="opacity-0 transition text-indigo-500 font-bold">Draft saved</span>
        </div>
      </div>
    </div>
  </main>

  <div id="contactsManagerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-5xl p-6 flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-slate-800">Contacts Manager</h3>
          <button onclick="window.closeContactsManager()" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="mb-4">
          <input type="text" id="cmSearch" onkeyup="window.renderContactsManagerTable(this.value)" placeholder="Search names, phones, or tags..." class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 shadow-sm">
      </div>
      <div class="border rounded-lg overflow-hidden bg-slate-50 flex-1 relative min-h-[300px]">
          <div class="absolute inset-0 overflow-auto">
              <table class="w-full text-xs">
                  <thead class="bg-slate-200 text-slate-700 sticky top-0 font-bold z-10 shadow-sm">
                      <tr>
                          <th class="p-3 text-left w-36 bg-slate-200">Phone</th>
                          <th class="p-3 text-left bg-slate-200">Name</th>
                          <th class="p-3 text-left bg-slate-200">Tags (comma separated)</th>
                      </tr>
                  </thead>
                  <tbody id="cmList" class="divide-y divide-slate-200 bg-white"></tbody>
              </table>
          </div>
      </div>
      <div class="flex justify-end gap-2 mt-4 pt-2 border-t border-slate-100">
          <div id="cmStatus" class="mr-auto text-xs text-slate-400 flex items-center"></div>
          <button onclick="window.closeContactsManager()" class="px-4 py-2 bg-slate-100 rounded hover:bg-slate-200 text-slate-700 font-bold transition">Cancel</button>
          <button onclick="window.saveContactsManager()" class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold shadow-sm transition">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="mergePurgeModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50 backdrop-blur-sm">
    <div class="w-[720px] max-w-[95vw] bg-white rounded-xl shadow-xl p-6 flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-slate-800">Merge / Purge Contacts</h3>
        <button onclick="window.closeMergePurge()" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-lg"></i></button>
      </div>
      <div id="autoMergeSection" class="mb-6 p-4 bg-indigo-50 border border-indigo-100 rounded-lg hidden">
        <div class="flex items-start gap-3">
            <div class="p-2 bg-white rounded-full text-indigo-600 shadow-sm"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
            <div class="flex-1">
                <h4 class="font-bold text-indigo-900 text-sm">Duplicate Contacts Detected</h4>
                <p class="text-xs text-indigo-700 mt-1">We found multiple threads for the same phone number (e.g., +1555... vs 555...).</p>
                <div id="autoMergeCount" class="text-xs font-bold text-indigo-800 mt-2"></div>
            </div>
            <button onclick="window.runAutoMerge()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 shadow-sm transition">Auto-Fix All</button>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <div class="text-xs font-bold text-slate-500 uppercase mb-1">Primary (Keep)</div>
          <select id="mpPrimary" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-slate-50 focus:ring-2 focus:ring-indigo-500"></select>
        </div>
        <div>
          <div class="text-xs font-bold text-slate-500 uppercase mb-1">Secondary (Merge & Delete)</div>
          <select id="mpSecondary" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-slate-50 focus:ring-2 focus:ring-indigo-500"></select>
        </div>
      </div>
      <div class="flex justify-end gap-2 pt-4 border-t border-slate-100">
        <div class="mr-auto text-xs text-slate-400 flex items-center" id="mpStatus">Select threads to merge manually.</div>
        <button onclick="window.runPurge()" class="px-4 py-2 rounded-lg bg-white border border-rose-200 text-rose-600 hover:bg-rose-50 text-xs font-bold transition">Purge Primary</button>
        <button onclick="window.runMerge()" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 text-xs font-bold transition shadow-sm">Merge Manual</button>
      </div>
    </div>
  </div>

  <div id="mergerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-6 flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-slate-800">Merge Legacy Data</h3>
        <button onclick="window.closeMergerModal()" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h4 class="text-sm font-bold text-slate-700">Step 1: Legacy Schedule</h4>
            <p class="text-[10px] text-slate-400 mb-2">Upload the file with 3 columns of names</p>
            <input type="file" id="mergeLegacyInput" accept=".csv,.xlsx" class="text-xs w-full text-slate-600">
        </div>
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h4 class="text-sm font-bold text-slate-700">Step 2: New Template</h4>
            <p class="text-[10px] text-slate-400 mb-2">Upload the file with phone numbers</p>
            <input type="file" id="mergeTemplateInput" accept=".csv" class="text-xs w-full text-slate-600">
        </div>
      </div>
      <button onclick="window.performMerge()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 font-bold shadow-sm mb-4 mx-auto block transition">Preview Merge</button>
      <div class="border rounded-lg overflow-hidden bg-slate-50 flex-1 relative min-h-[300px]">
        <div class="absolute inset-0 overflow-auto">
          <table class="w-full text-xs">
            <thead class="bg-slate-200 text-slate-700 sticky top-0 font-bold z-10">
              <tr><th class="p-2 border-b w-10"></th><th class="text-left p-2 border-b">Name</th><th class="text-left p-2 border-b">Vehicle</th><th class="text-left p-2 border-b">Tablet</th><th class="text-left p-2 border-b">Status</th></tr>
            </thead>
            <tbody id="mergePreview" class="divide-y divide-slate-200 bg-white"></tbody>
          </table>
        </div>
      </div>
      <div class="flex justify-between items-center mt-4">
        <div class="text-xs text-slate-500" id="mergeSummary">Waiting for files...</div>
        <button onclick="window.downloadMergedCsv()" id="downloadMergeBtn" disabled class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition">Download Merged CSV</button>
      </div>
    </div>
  </div>

  <div id="assignmentsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-6 flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold text-slate-800">Trip Assignments</h3>
        <button onclick="window.closeAssignmentsModal()" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-lg"></i></button>
      </div>
      <div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl p-4 mb-4 flex items-center justify-center gap-4">
        <div class="text-center"><h4 class="text-sm font-bold text-slate-700">Upload CSV</h4><p class="text-[10px] text-slate-400">Use Merged Template</p></div>
        <button onclick="document.getElementById('assignmentsCsvInput').click()" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 font-bold rounded-lg text-xs hover:border-indigo-500 hover:text-indigo-600 transition">Browse</button>
        <input type="file" id="assignmentsCsvInput" accept=".csv" class="hidden" onchange="window.handleAssignmentsCsv(this)">
      </div>
      <div class="bg-slate-100 p-3 rounded-lg border border-slate-200 mb-4 flex gap-2 items-end shadow-inner">
        <div class="flex-1"><label class="block text-[10px] font-bold text-slate-500 uppercase">Name</label><input type="text" id="manualName" class="w-full text-xs p-2 border rounded shadow-sm"></div>
        <div class="w-32"><label class="block text-[10px] font-bold text-slate-500 uppercase">Phone</label><input type="tel" id="manualPhone" class="w-full text-xs p-2 border rounded shadow-sm"></div>
        <div class="flex-[2]"><label class="block text-[10px] font-bold text-slate-500 uppercase">Message</label><input type="text" id="manualMsg" class="w-full text-xs p-2 border rounded shadow-sm"></div>
        <button onclick="window.addManualRow()" class="px-4 py-2 bg-indigo-600 text-white rounded text-xs font-bold h-[34px] shadow-sm hover:bg-indigo-700 transition">Add</button>
      </div>
      <div class="border rounded-lg overflow-hidden bg-slate-50 flex-1 relative min-h-[200px]">
        <div class="absolute inset-0 overflow-auto">
          <table class="w-full text-xs">
            <thead class="bg-slate-200 text-slate-700 sticky top-0 font-bold z-10 shadow-sm">
              <tr><th class="p-3 w-10 bg-slate-200 border-b text-center"><i class="fa-solid fa-check"></i></th><th class="text-left p-3 w-40 bg-slate-200 border-b">Driver / Tag</th><th class="text-left p-3 w-28 bg-slate-200 border-b">Phone</th><th class="text-left p-3 bg-slate-200 border-b">Message</th><th class="text-left p-3 w-28 bg-slate-200 border-b">Status</th></tr>
            </thead>
            <tbody id="assignmentsPreview" class="divide-y divide-slate-200 bg-white"></tbody>
          </table>
        </div>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-xs text-slate-500 font-medium" id="assignmentsSummary">0 rows</div>
        <div class="flex gap-2">
          <button onclick="window.closeAssignmentsModal()" class="px-4 py-2 text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition">Close</button>
          <button id="sendAllAssignmentsBtn" onclick="window.sendAllAssignments()" class="px-6 py-2 text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg font-bold shadow-sm transition">Send Selected</button>
        </div>
      </div>
    </div>
  </div>

  <div id="broadcastModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-xl w-full max-w-4xl p-6"><h3 class="text-lg font-bold mb-3">Broadcast</h3><textarea id="broadcastMsgInput" oninput="window.updateBroadcastPreview(this.value)" class="w-full text-sm p-3 border rounded mb-4" rows="3"></textarea><div class="max-h-64 overflow-auto border rounded mb-4"><table class="w-full text-xs"><tbody id="broadcastPreview"></tbody></table></div><div class="flex justify-end gap-2"><button onclick="window.closeBroadcastModal()" class="px-4 py-2 bg-slate-100 rounded">Cancel</button><button onclick="window.sendBroadcast()" class="px-6 py-2 bg-indigo-600 text-white rounded">Send</button></div></div></div>
  <div id="newMsgModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-xl w-full max-w-md p-6"><h3 class="text-lg font-bold mb-4">New Msg</h3><input id="newContactPhone" class="w-full border p-2 mb-2 rounded" placeholder="Phone"><input id="newContactName" class="w-full border p-2 mb-2 rounded" placeholder="Name"><button onclick="window.createThreadFromModal()" class="w-full bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">Create</button><button onclick="window.closeNewMsgModal()" class="w-full mt-2 bg-slate-100 p-2 rounded hover:bg-slate-200">Cancel</button></div></div>
  <div id="threadInfoModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-xl p-6"><h3 class="font-bold mb-2">Thread Info</h3><input id="threadInfoName" class="border w-full p-2 mb-2 rounded"><input id="threadInfoTags" class="border w-full p-2 mb-4 rounded"><button onclick="window.saveThreadInfo()" class="bg-indigo-600 text-white px-4 py-2 rounded mr-2 hover:bg-indigo-700">Save</button><button onclick="window.closeThreadInfo()" class="bg-slate-100 px-4 py-2 rounded hover:bg-slate-200">Close</button><p id="threadInfoPhone" class="hidden"></p></div></div>
  <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-xl p-6 w-full max-w-xl"><h3 class="font-bold mb-3">Settings</h3><textarea id="cannedRepliesInput" class="w-full border p-2 mb-3 text-sm h-32 rounded"></textarea><div class="flex justify-end gap-2"><button onclick="window.closeSettingsModal()" class="px-4 py-2 bg-slate-100 rounded hover:bg-slate-200">Close</button><button onclick="window.saveSettings()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save</button></div></div></div>
  <div id="threadSearchModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-xl p-6 w-full max-w-3xl"><h3 class="font-bold mb-3">Search</h3><input id="threadSearchInput" class="w-full border p-2 mb-2 rounded" placeholder="Query..."><div id="threadSearchResults" class="max-h-64 overflow-auto border p-2 mb-2 text-sm rounded"></div><button onclick="window.runThreadSearch()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Go</button><button onclick="window.closeThreadSearch()" class="bg-slate-100 px-4 py-2 rounded ml-2 hover:bg-slate-200">Close</button></div></div>

<script type="module">
  const SMS_BACKEND_BASE = "https://sms-backend-3488.twil.io";
  const TWILIO_SEND_URL = `${SMS_BACKEND_BASE}/send-sms`;
  const TWILIO_GET_URL = `${SMS_BACKEND_BASE}/get-messages`;
  const TWILIO_DELETE_URL = `${SMS_BACKEND_BASE}/delete-thread`;
  const TWILIO_DELETE_MSG_URL = `${SMS_BACKEND_BASE}/delete-message`;
  const SHARED_ORG_ID = "dispatch_team_main";
  const ASSIGNMENT_DISCLAIMER = "\n\nThis is a beta test for ride assignments, you will still receive a text from the original number, if assignment info doesn't match, contact dispatch for clarity.";

  const LS = { pinned: "omnichat_pinned", drafts: "omnichat_drafts", canned: "omnichat_canned", filters: "omnichat_filters", deletedSids: "deletedSids" };
  const firebaseConfig = { apiKey: "AIzaSyCaypEoug2f7OTJjKOdkkJPaZDypcr3NF8", authDomain: "sms-dlx.firebaseapp.com", projectId: "sms-dlx", storageBucket: "sms-dlx.firebasestorage.app", messagingSenderId: "522453095698", appId: "1:522453095698:web:ea217285e6e5160ee4cfcb", measurementId: "G-1BRSKD75YX" };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, getDoc, onSnapshot, query, orderBy, limit, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
  const storage = getStorage(app);
  let store = { 
    uid: null, threads: [], activeThreadId: null, activeThread: null, lastInboundSidSeen: new Set(), deletedSids: new Set(), openGroups: new Set(), initialGroupSet: false, isPolling: false,
    pinned: new Set(), onlyUnread: false, onlyPinned: false, tagFilter: new Set(), drafts: {}, cannedReplies: []
  };
  let assignmentsRows = []; let broadcastRows = []; let mergedCsvContent = "";
  let unsubThreads = null; let unsubMessages = null;

  const escapeHtml = (t) => { const d = document.createElement("div"); d.textContent = t??""; return d.innerHTML; };
  const normalizePhone = (r) => { const s=(r||"").toString().trim(), d=s.replace(/\D/g,""); if(!d)return""; if(s.startsWith("+"))return`+${d}`; if(d.length===10)return`+1${d}`; if(d.length===11&&d.startsWith("1"))return`+${d}`; return`+${d}`; };
  const nameKey = (s) => (s||"").toLowerCase().replace(/[^a-z0-9]/g, "");
  const parseTags = (r) => (r||"").split(",").map(x=>x.trim()).filter(Boolean).slice(0,30);
  const initials = (s) => (s||"?").trim().slice(0,2).toUpperCase()||"?";
  const formatTime = (ms) => (!ms) ? "" : new Date(ms).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  const scrollToBottom = () => { const el = document.getElementById("chatContainer"); if(el) el.scrollTop = el.scrollHeight; };
  const safeId = (s) => (s || "").toString().replace(/[^a-zA-Z0-9_-]/g, "");

  const getThreadsCol = () => collection(db, "organizations", SHARED_ORG_ID, "threads");
  const getThreadDoc = (id) => doc(db, "organizations", SHARED_ORG_ID, "threads", id);
  const getMsgsCol = (id) => collection(db, "organizations", SHARED_ORG_ID, "threads", id, "messages");

  // SETTINGS
  function loadLocalSettings() {
    try { const s = localStorage.getItem(LS.deletedSids); if(s) store.deletedSids = new Set(JSON.parse(s)); } catch{}
    try { const p = JSON.parse(localStorage.getItem(LS.pinned)||"[]"); store.pinned = new Set(p); } catch{}
    try { const d = JSON.parse(localStorage.getItem(LS.drafts)||"{}"); store.drafts = d; } catch{}
    try { const c = JSON.parse(localStorage.getItem(LS.canned)||"[]"); store.cannedReplies = c; } catch{}
    try { const f = JSON.parse(localStorage.getItem(LS.filters)||"{}"); store.onlyUnread=!!f.onlyUnread; store.onlyPinned=!!f.onlyPinned; store.tagFilter=new Set(f.tagFilter||[]); } catch{}
    if(!store.cannedReplies.length) store.cannedReplies = ["Please sign into your tablet.", "Copy. Thank you.", "Running late.", "Call dispatch.", "Check your zone."];
  }
  function saveLocalSettings() {
    localStorage.setItem(LS.deletedSids, JSON.stringify([...store.deletedSids]));
    localStorage.setItem(LS.pinned, JSON.stringify([...store.pinned]));
    localStorage.setItem(LS.drafts, JSON.stringify(store.drafts));
    localStorage.setItem(LS.canned, JSON.stringify(store.cannedReplies));
    localStorage.setItem(LS.filters, JSON.stringify({onlyUnread:store.onlyUnread, onlyPinned:store.onlyPinned, tagFilter:[...store.tagFilter]}));
  }

  async function pollIncomingMessages() {
    if(!store.uid || store.isPolling) return;
    store.isPolling = true;
    try {
      const res = await fetch(TWILIO_GET_URL);
      const data = await res.json();
      if(!data.success || !data.messages) { store.isPolling = false; return; }
      for(let m of data.messages) {
        if(store.deletedSids.has(m.sid) || store.lastInboundSidSeen.has(m.sid)) continue;
        store.lastInboundSidSeen.add(m.sid);
        if(m.direction === 'inbound') {
          const cleanPhone = normalizePhone(m.from);
          if(cleanPhone.length > 5) {
            const q = query(getMsgsCol(cleanPhone), where("sid", "==", m.sid));
            const querySnap = await getDocs(q);
            if (querySnap.empty) {
              await upsertThread(cleanPhone, cleanPhone, ["New"]);
              await setDoc(doc(getMsgsCol(cleanPhone), m.sid), { body: m.body, direction: "received", createdAt: serverTimestamp(), sid: m.sid, mediaUrls: (m.mediaUrls || m.media || m.MediaUrl || []) });
              const threadRef = getThreadDoc(cleanPhone);
              const tSnap = await getDoc(threadRef);
              const currentUnread = tSnap.exists() ? (tSnap.data().unread || 0) : 0;
              const updates = { lastMessageText: m.body, lastMessageAtMs: Date.now() };
              if(store.activeThreadId !== cleanPhone) { updates.unread = currentUnread + 1; }
              await updateDoc(threadRef, updates);
              document.getElementById("notifSound").play().catch(()=>{});
            }
          }
        }
      }
    } catch(e) { console.error("Poll error", e); }
    finally { store.isPolling = false; }
  }

  // --- NEW CONTACT MANAGER LOGIC ---
  window.openContactsManager = () => {
    document.getElementById("contactsManagerModal").classList.remove("hidden");
    window.renderContactsManagerTable();
  };
  window.closeContactsManager = () => document.getElementById("contactsManagerModal").classList.add("hidden");

  window.renderContactsManagerTable = (filter = "") => {
    const tbody = document.getElementById("cmList");
    tbody.innerHTML = "";
    const f = filter.toLowerCase();
    
    // Sort by name or phone
    const list = store.threads.filter(t => 
        (t.name||"").toLowerCase().includes(f) || 
        (t.phone||"").includes(f) ||
        (t.tags||[]).join(" ").toLowerCase().includes(f)
    ).sort((a,b) => (a.name||"").localeCompare(b.name||""));

    list.forEach(t => {
        const tr = document.createElement("tr");
        const tagStr = (t.tags || []).join(", ");
        tr.innerHTML = `
            <td class="p-3 font-mono text-slate-500 border-b">${t.phone}</td>
            <td class="p-3 border-b"><input type="text" class="cm-name-input w-full border rounded px-2 py-1 focus:ring-2 focus:ring-indigo-500 text-slate-700" data-id="${t.id}" value="${escapeHtml(t.name)}"></td>
            <td class="p-3 border-b"><input type="text" class="cm-tags-input w-full border rounded px-2 py-1 focus:ring-2 focus:ring-indigo-500 text-slate-700" data-id="${t.id}" value="${escapeHtml(tagStr)}"></td>
        `;
        tbody.appendChild(tr);
    });
    document.getElementById("cmStatus").innerText = `Showing ${list.length} contacts`;
  };

  window.saveContactsManager = async () => {
    const names = document.querySelectorAll(".cm-name-input");
    const tags = document.querySelectorAll(".cm-tags-input");
    const updates = [];
    const btn = document.querySelector("#contactsManagerModal button.bg-indigo-600");
    
    btn.disabled = true; 
    btn.innerText = "Saving...";

    // Map current state for comparison
    const currentMap = new Map(store.threads.map(t => [t.id, t]));

    for (let i = 0; i < names.length; i++) {
        const id = names[i].dataset.id;
        const newName = names[i].value.trim();
        const newTags = tags[i].value.split(",").map(t => t.trim()).filter(Boolean);
        
        const original = currentMap.get(id);
        
        // Check if update is needed
        const tagsChanged = JSON.stringify(original.tags || []) !== JSON.stringify(newTags);
        const nameChanged = (original.name || "") !== newName;

        if (nameChanged || tagsChanged) {
            updates.push({ id, name: newName, tags: newTags });
        }
    }

    if (updates.length === 0) {
        btn.disabled = false;
        btn.innerText = "Save Changes";
        window.closeContactsManager();
        return;
    }

    if (!confirm(`Update ${updates.length} contacts?`)) {
        btn.disabled = false;
        btn.innerText = "Save Changes";
        return;
    }

    try {
        const promises = updates.map(u => updateDoc(getThreadDoc(u.id), { name: u.name, tags: u.tags }));
        await Promise.all(promises);
        alert("Contacts updated successfully.");
        window.closeContactsManager();
    } catch (e) {
        console.error(e);
        alert("Error saving contacts: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "Save Changes";
    }
  };

  // --- TOOLS ---
  window.openMergerModal = () => document.getElementById("mergerModal").classList.remove("hidden");
  window.closeMergerModal = () => document.getElementById("mergerModal").classList.add("hidden");
  window.performMerge = async function() {
    const lf = document.getElementById("mergeLegacyInput").files?.[0];
    const tf = document.getElementById("mergeTemplateInput").files?.[0];
    if(!lf || !tf) return alert("Select both files.");
    const lt = await lf.text(); const tt = await tf.text();
    const lmap = new Map();
    let colMode = 0;
    lt.split(/\r?\n/).forEach(l => { 
        const p = parseCsvLine(l);
        if(p[0] && (p[0].toLowerCase().includes("origin") || p[0].toLowerCase().includes("portland"))) colMode=1;
        if(p[0]) { if(colMode===0) lmap.set(nameKey(p[0]), {v:p[1], t:p[2]}); else lmap.set(nameKey(p[0]), {v:p[2], t:p[3]}); }
        if(p[6]) lmap.set(nameKey(p[6]), {v:p[8], t:p[9]});
        if(p[12]) lmap.set(nameKey(p[12]), {v:p[14], t:p[15]});
    });
    const tLines = tt.split(/\r?\n/);
    let nLines = [tLines[0]]; let html = ""; let matches = 0;
    for(let i=1; i<tLines.length; i++) {
        const l = tLines[i].trim(); if(!l) continue;
        const c = parseCsvLine(l);
        const name = c[4] || ""; const nk = nameKey(name);
        let nv = c[5] || "", nt = c[6] || "", st = "No Match";
        if(lmap.has(nk)) { const leg = lmap.get(nk); if(leg.v) nv = leg.v; if(leg.t) nt = leg.t; st = "Merged"; matches++; }
        c[5] = nv; c[6] = nt;
        nLines.push(c.map(x=>`"${x.replace(/"/g,'""')}"`).join(","));
        if(st==="Merged") html += `<tr><td class="p-2 text-center"><i class="fa-solid fa-check text-green-500"></i></td><td class="p-2 font-bold">${escapeHtml(name)}</td><td class="p-2 text-blue-600">${escapeHtml(nv)}</td><td class="p-2 text-blue-600">${escapeHtml(nt)}</td><td class="p-2 text-green-600 font-bold">${st}</td></tr>`;
    }
    document.getElementById("mergePreview").innerHTML = html;
    document.getElementById("mergeSummary").innerText = `Matched ${matches}. Ready.`;
    document.getElementById("downloadMergeBtn").disabled = false;
    mergedCsvContent = nLines.join("\n");
  };
  window.downloadMergedCsv = function() {
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([mergedCsvContent], {type:"text/csv"})); a.download = "Merged_Template.csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };
  window.openMergePurge = () => { document.getElementById("mergePurgeModal").classList.remove("hidden"); document.getElementById("mergePurgeModal").classList.add("flex"); populateMergePurgeDropdowns(); };
  window.closeMergePurge = () => { document.getElementById("mergePurgeModal").classList.add("hidden"); document.getElementById("mergePurgeModal").classList.remove("flex"); };
  async function populateMergePurgeDropdowns() {
    const p = document.getElementById("mpPrimary"), s = document.getElementById("mpSecondary");
    const threads = (store.threads||[]).slice().sort((a,b)=>(b.lastMessageAtMs||0)-(a.lastMessageAtMs||0));
    const opts = threads.map(t=>`<option value="${escapeHtml(t.id)}">${escapeHtml(t.name||t.phone||t.id)} (${t.id})</option>`).join("");
    p.innerHTML = opts; s.innerHTML = opts;
    // Auto duplicates
    const grps = new Map(); threads.forEach(t=>{const k=normalizePhone(t.id||t.phone); if(k.length>6){if(!grps.has(k))grps.set(k,[]); grps.get(k).push(t);}});
    const dupes = [...grps.entries()].filter(x=>x[1].length>1);
    const box = document.getElementById("autoMergeSection");
    if(dupes.length>0) { box.classList.remove("hidden"); document.getElementById("autoMergeCount").innerText = `${dupes.length} duplicates found (e.g. ${dupes[0][0]})`; } else box.classList.add("hidden");
  }
  window.runAutoMerge = async function() {
      if(!confirm("Automatically merge all duplicates based on phone numbers?")) return;
      const grps = new Map(); (store.threads||[]).forEach(t=>{const k=normalizePhone(t.id||t.phone); if(k.length>6){if(!grps.has(k))grps.set(k,[]); grps.get(k).push(t);}});
      for (const [k, arr] of grps.entries()) {
          if(arr.length<2) continue;
          arr.sort((a,b)=>(b.lastMessageAtMs||0)-(a.lastMessageAtMs||0));
          const primary = arr[0];
          for (let i=1; i<arr.length; i++) await mergeThreads(primary.id, arr[i].id);
      }
      alert("Auto-Merge Complete."); window.location.reload();
  }
  window.runMerge = async function() {
    const p = document.getElementById("mpPrimary").value, s = document.getElementById("mpSecondary").value;
    if(!p || !s || p===s) return alert("Invalid selection");
    if(confirm("Merge?")) { await mergeThreads(p,s); alert("Merged"); window.location.reload(); }
  };
  window.runPurge = async function() {
    const p = document.getElementById("mpPrimary").value; if(!p) return;
    if(confirm("Purge?")) { await deleteThreadDeep(p); alert("Purged"); window.location.reload(); }
  };
  async function listAllMessages(tid) { const s=await getDocs(getMsgsCol(tid)); const o=[]; s.forEach(d=>o.push({id:d.id,...d.data()})); return o; }
  async function deleteThreadDeep(tid) { const m=await listAllMessages(tid); for(const x of m) await deleteDoc(doc(getMsgsCol(tid),x.id)); await deleteDoc(getThreadDoc(tid)); }
  async function mergeThreads(pid, sid) {
      const ps=await getDoc(getThreadDoc(pid)), ss=await getDoc(getThreadDoc(sid)); if(!ps.exists()||!ss.exists()) return;
      const m=await listAllMessages(sid); for(const x of m) await setDoc(doc(getMsgsCol(pid), `m-${sid}-${x.id}`), {...x, merged:true}, {merge:true});
      await deleteThreadDeep(sid);
  }

  // --- ASSIGNMENTS ---
  window.openAssignmentsModal = () => document.getElementById("assignmentsModal").classList.remove("hidden");
  window.closeAssignmentsModal = () => document.getElementById("assignmentsModal").classList.add("hidden");
  window.addManualRow = function() {
    const n = document.getElementById("manualName").value.trim()||"Manual"; const p = document.getElementById("manualPhone").value.trim(); const m = document.getElementById("manualMsg").value.trim();
    if(!p) return alert("Phone req");
    assignmentsRows.unshift({ driverName:n, phone:normalizePhone(p), message:m, tag:"Manual", selected:true, hasTrip:true, status:"READY" });
    document.getElementById("manualName").value=""; document.getElementById("manualPhone").value=""; document.getElementById("manualMsg").value="";
    window.renderAssignmentsPreview();
  };
  window.handleAssignmentsCsv = async function(inp) {
    const file = inp.files?.[0]; inp.value = ""; if (!file || !store.uid) return;
    const text = await file.text(); const lines = text.split(/\r?\n/);
    let dateStr = parseCsvLine(lines[0])[0]; if(!dateStr || !/\d/.test(dateStr)) { const r2 = parseCsvLine(lines[1]); if(r2[0] && /\d/.test(r2[0])) dateStr = r2[0]; }
    const dow = getDayOfWeek(dateStr);
    const smap = { "eugene":"DLX-EUG", "deluxe":"DLX-EUG", "roseburg":"RBG", "portland/i-84 corridor":"PDX", "albany/corvallis/salem":"XLB", "direct medical transport":"DMT", "coast":"XCC" };
    let curTag = "Auto-Assign", curSec = ""; assignmentsRows = [];
    const cmap = await buildContactsMap();

    for(let i=0; i<lines.length; i++) {
        const p = parseCsvLine(lines[i]); if(p.length<1) continue;
        const cA = (p[0]||"").trim().toLowerCase();
        if(smap[cA] || cA.includes("direct medical")) { curSec=cA; curTag=smap[cA]||"DMT"; continue; }
        if(cA.includes("p/u time")) continue;
        const name = (p[4]||"").trim(); if(!name || name.toLowerCase().includes("name") || name.toLowerCase().includes("corridor")) continue;
        
        const pu = (p[0]||"").trim(), city = (p[1]||"").trim(), cli = (p[2]||"").trim();
        let ph = (p[3]||"").trim(), veh = (p[5]||"").trim(), tab = (p[6]||"").trim();
        if(!ph) ph = cmap.get(nameKey(name))||"";
        
        const hasTrip = (pu && city && cli);
        const isED = (curSec.includes("eugene") || curSec.includes("deluxe") || curSec.includes("direct medical") || curSec === "dmt");
        let msg = "";
        
        if(isED) { 
            msg = `${dow}: CLOCK IN AT ${tab||"?"}. Assigned vehicle is ${veh||"?"}.`; 
        } else { 
            if(hasTrip) msg = `${dow}: ${pu} pickup in ${city} (${cli}), be signed into your tablet @ ${tab} to receive ride.`; else msg = "(No Trip Data)"; 
        }
        const isSelected = hasTrip;
        assignmentsRows.push({ driverName:name, phone:normalizePhone(ph), message:msg, tag:curTag, selected:isSelected, hasTrip:hasTrip });
    }
    window.renderAssignmentsPreview();
  };
  window.updateAssignmentRow = function(idx, val) { if(assignmentsRows[idx]) { assignmentsRows[idx].message = val; if(val.trim().length>0 && !assignmentsRows[idx].hasTrip) { assignmentsRows[idx].selected = true; document.getElementById(`assign-cb-${idx}`).checked = true; } } };
  window.toggleAssignmentRow = function(idx, chk) { if(assignmentsRows[idx]) assignmentsRows[idx].selected = chk; window.renderAssignmentsPreview(); };
  window.renderAssignmentsPreview = function() {
    const tb = document.getElementById("assignmentsPreview"); tb.innerHTML = "";
    const sel = assignmentsRows.filter(r=>r.selected).length;
    assignmentsRows.forEach((r,i) => {
        let msgHtml = `<input type="text" class="w-full text-xs p-1 border rounded focus:ring-2 focus:ring-indigo-500" value="${escapeHtml(r.message)}" oninput="window.updateAssignmentRow(${i},this.value)">`;
        let st = r.selected ? "SENDING" : (r.hasTrip ? "EXCLUDED" : "NO DATA");
        let cl = r.selected ? "text-green-600 font-bold" : "text-slate-400";
        tb.innerHTML += `<tr class="hover:bg-slate-50"><td class="p-3 border-b text-center"><input type="checkbox" id="assign-cb-${i}" ${r.selected?"checked":""} onchange="window.toggleAssignmentRow(${i},this.checked)"></td><td class="p-3 border-b font-bold">${escapeHtml(r.driverName)}</td><td class="p-3 border-b font-mono">${r.phone}</td><td class="p-3 border-b">${msgHtml}</td><td class="p-3 border-b text-xs ${cl}">${st}</td></tr>`;
    });
    document.getElementById("assignmentsSummary").innerText = `Found ${assignmentsRows.length}. ${sel} selected.`;
  };
  window.sendAllAssignments = async function() {
    const valid = assignmentsRows.filter(r => r.selected && r.message.trim() && r.phone.length>5);
    if(!valid.length) return alert("No valid rows."); if(!confirm(`Send to ${valid.length}?`)) return;
    const btn = document.getElementById("sendAllAssignmentsBtn"); btn.disabled = true; btn.innerText = "Sending...";
    for(const r of valid) {
        try {
            const m = r.message + ASSIGNMENT_DISCLAIMER;
            await sendSmsApi(r.phone, m);
            await upsertThread(r.phone, r.driverName, [r.tag]);
            await addMessageToFirestore(normalizePhone(r.phone), m, "sent", {});
        } catch(e) { console.error(e); }
    }
    alert("Sent."); btn.disabled = false; btn.innerText = "Send Selected"; window.closeAssignmentsModal();
  };

  // BROADCAST
  window.closeBroadcastModal = () => document.getElementById("broadcastModal").classList.add("hidden");
  window.handleBroadcastCsv = async function(inp) {
    const f=inp.files?.[0]; inp.value=""; if(!f)return; const t=await f.text(); broadcastRows=[];
    t.split(/\r?\n/).forEach(l => { const p=parseCsvLine(l); if(p[4] && !p[0].includes("p/u")) broadcastRows.push({driverName:p[4], phone:normalizePhone(p[3])}); });
    document.getElementById("broadcastMsgInput").value = ""; window.updateBroadcastPreview(""); document.getElementById("broadcastModal").classList.remove("hidden");
  };
  window.updateBroadcastPreview = function(v) { const t = document.getElementById("broadcastPreview"); t.innerHTML=""; broadcastRows.forEach(r=>{t.innerHTML+=`<tr><td class="p-2">${r.driverName}</td><td class="p-2 font-mono">${r.phone}</td><td class="p-2 italic text-xs">${escapeHtml(v)}</td></tr>`}); };
  window.sendBroadcast = async function() {
    const m = document.getElementById("broadcastMsgInput").value.trim(); if(!m) return alert("Msg empty");
    const r = broadcastRows.filter(x=>x.phone.length>5); if(!confirm(`Send to ${r.length}?`)) return;
    for(let row of r) { await sendSmsApi(row.phone, m); await addMessageToFirestore(row.phone, m, "sent", {}); }
    alert("Sent."); window.closeBroadcastModal();
  };

  // COMMON & UI
  function getDayOfWeek(d) { try{ return new Date(d).toLocaleDateString('en-US',{weekday:'long'}).toUpperCase(); }catch{return "TODAY";} }
  function parseCsvLine(l) { const o=[]; let c="", q=false; for(let x of l){ if(x==='"')q=!q; else if(x===','&&!q){o.push(c.trim());c="";} else c+=x; } o.push(c.trim()); return o; }
  async function buildContactsMap() { return new Promise(r=>onSnapshot(query(getThreadsCol()), s=>{const m=new Map();s.forEach(d=>m.set(nameKey(d.data().name), d.data().phone));r(m);})); }
  
  window.openNewMsgModal=()=>document.getElementById("newMsgModal").classList.remove("hidden");
  window.closeNewMsgModal=()=>document.getElementById("newMsgModal").classList.add("hidden");
  window.closeThreadInfo=()=>document.getElementById("threadInfoModal").classList.add("hidden");
  window.toggleMobileSidebar=()=>document.getElementById("sidebar").classList.toggle("-translate-x-full");
  window.resetLocalUI=()=>{store.openGroups.clear();window.renderThreadList();alert("Reset");};
  window.createThreadFromModal=async()=>{const p=document.getElementById("newContactPhone").value; await upsertThread(p, document.getElementById("newContactName").value, []); window.closeNewMsgModal(); loadThread(normalizePhone(p));};
  window.saveThreadInfo=async()=>{ if(store.activeThreadId) await updateDoc(getThreadDoc(store.activeThreadId), {name:document.getElementById("threadInfoName").value, tags:parseTags(document.getElementById("threadInfoTags").value)}); window.closeThreadInfo(); };
  window.openThreadInfo=()=>{ if(!store.activeThread)return; document.getElementById("threadInfoName").value=store.activeThread.name; document.getElementById("threadInfoTags").value=(store.activeThread.tags||[]).join(", "); document.getElementById("threadInfoPhone").innerText = store.activeThread.phone; document.getElementById("threadInfoModal").classList.remove("hidden"); };
  window.handleCsvUpload=async function(inp) { const file=inp.files?.[0]; inp.value=""; if(!file)return; const t=await file.text(); const lines=t.split(/\r?\n/).filter(l=>l.trim()); for(let l of lines){ const p=parseCsvLine(l); if(p.length>=2 && p[0].toLowerCase()!=="first name"){ let n=p[0],ph=p[1]; if(p.length>5){n=p[0]+" "+p[2];ph=p[18]||p[35];} if(normalizePhone(ph).length>5) await upsertThread(ph,n,[]); } } alert("Imported"); };

  window.openSettingsModal = () => { document.getElementById("cannedRepliesInput").value = store.cannedReplies.join("\n"); document.getElementById("settingsModal").classList.remove("hidden"); };
  window.closeSettingsModal = () => document.getElementById("settingsModal").classList.add("hidden");
  window.saveSettings = () => { store.cannedReplies = document.getElementById("cannedRepliesInput").value.split("\n").filter(Boolean); saveLocalSettings(); renderQuickReplies(); window.closeSettingsModal(); };
  
  window.toggleUnreadOnly = () => { store.onlyUnread=!store.onlyUnread; saveLocalSettings(); window.renderThreadList(); };
  window.togglePinnedOnly = () => { store.onlyPinned=!store.onlyPinned; saveLocalSettings(); window.renderThreadList(); };
  window.togglePinThread = (id) => { if(store.pinned.has(id)) store.pinned.delete(id); else store.pinned.add(id); saveLocalSettings(); window.renderThreadList(); };
  window.toggleGroup = (k) => { if(store.openGroups.has(k)) store.openGroups.delete(k); else store.openGroups.add(k); window.renderThreadList(); };
  
  window.openThreadSearch = () => { if(!store.activeThreadId) return alert("Select thread"); document.getElementById("threadSearchModal").classList.remove("hidden"); };
  window.closeThreadSearch = () => document.getElementById("threadSearchModal").classList.add("hidden");
  window.runThreadSearch = async () => {
     const q=document.getElementById("threadSearchInput").value.toLowerCase();
     const snap=await getDocs(query(getMsgsCol(store.activeThreadId), orderBy("createdAt","desc"), limit(500)));
     const res=document.getElementById("threadSearchResults"); res.innerHTML="";
     snap.forEach(d=>{ const m=d.data(); if((m.body||"").toLowerCase().includes(q)) res.innerHTML+=`<div class="p-2 border-b"><div class="text-xs text-gray-400">${formatTime(m.createdAt?.toMillis())}</div><div>${escapeHtml(m.body)}</div></div>`; });
  };
  
  window.exportActiveThreadCsv = async () => {
    if(!store.activeThreadId) return alert("Select thread");
    const snap=await getDocs(query(getMsgsCol(store.activeThreadId), orderBy("createdAt","asc")));
    let csv="Date,Direction,Message\n";
    snap.forEach(d=>{ const m=d.data(); csv+=`"${new Date(m.createdAt?.toMillis()).toLocaleString()}","${m.direction}","${(m.body||"").replace(/"/g,'""')}"\n`; });
    const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download=`thread_${store.activeThreadId}.csv`; document.body.appendChild(a); a.click(); a.remove();
  };

  window.loadThread = async function(threadId) {
    if(unsubMessages) { unsubMessages(); unsubMessages = null; }
    store.activeThreadId = threadId;
    store.activeThread = store.threads.find(t => t.id === threadId);
    document.getElementById("welcomeState").classList.add("hidden");
    document.getElementById("activeContactName").innerText = store.activeThread?.name || "Unknown";
    document.getElementById("activeContactPhone").innerText = store.activeThread?.phone || "";
    document.getElementById("activeContactAvatar").innerText = initials(store.activeThread?.name);
    
    // tags in header
    const te = document.getElementById("activeTags"); if(te) {
        te.innerHTML = (store.activeThread?.tags||[]).slice(0,5).map(t=>`<span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 rounded-full text-[10px] border border-indigo-100">${escapeHtml(t)}</span>`).join("");
    }

    try { await updateDoc(getThreadDoc(threadId), { unread: 0 }); } catch(e) {}
    const q = query(getMsgsCol(threadId), orderBy("createdAt", "asc"));
    unsubMessages = onSnapshot(q, s => {
      const div = document.getElementById("messageList"); div.innerHTML = ""; const seen = new Set();
      s.forEach(d => {
        const m = d.data(); const fps = (m.body||"") + Math.floor((m.createdAt?.toMillis()||0)/1000); if(seen.has(fps)) return; seen.add(fps);
        const el = document.createElement("div"); el.className = `flex ${m.direction==='sent'?'justify-end':'justify-start'} fade-in-up`;
        el.innerHTML = `<div class="group relative max-w-[75%]"><div class="p-3 text-sm shadow-sm ${m.direction==='sent'?'msg-sent':'msg-received'}"><p>${escapeHtml(m.body)}</p>${renderMedia(m.mediaUrls)}<div class="text-[10px] opacity-70 mt-1 text-right flex justify-between items-center"><span>${formatTime(m.createdAt?.toMillis())}</span><button onclick="window.deleteSingleMessage('${threadId}','${d.id}','${m.sid||''}')" class="ml-2 text-red-300 hover:text-red-100 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button></div></div></div>`;
        div.appendChild(el);
      });
      scrollToBottom();
    });
    renderQuickReplies();
    if(window.innerWidth < 768) window.toggleMobileSidebar();
    window.renderThreadList();
  };

  window.renderThreadList = function() {
    // 1. Update Buttons
    const ub=document.getElementById("unreadOnlyBtn"), pb=document.getElementById("pinnedOnlyBtn");
    if(ub) ub.className=`flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide border transition ${store.onlyUnread?'bg-indigo-600 text-white border-indigo-600':'bg-white text-slate-600 border-slate-200 hover:shadow-sm'}`;
    ifwindow.renderThreadList = function() {
    // 0. GLOBAL SORT: Ensure newest messages are always first, regardless of view
    store.threads.sort((a, b) => (b.lastMessageAtMs || 0) - (a.lastMessageAtMs || 0));

    // 1. Update Buttons (Unread / Pinned)
    const ub=document.getElementById("unreadOnlyBtn"), pb=document.getElementById("pinnedOnlyBtn");
    if(ub) ub.className=`flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide border transition ${store.onlyUnread?'bg-indigo-600 text-white border-indigo-600':'bg-white text-slate-600 border-slate-200 hover:shadow-sm'}`;
    if(pb) pb.className=`flex-1 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide border transition ${store.onlyPinned?'bg-indigo-600 text-white border-indigo-600':'bg-white text-slate-600 border-slate-200 hover:shadow-sm'}`;
    
    // 2. Render Tag Chips (Filters)
    const tc=document.getElementById("tagChips"); tc.innerHTML="";
    
    // --- NEW: "ALL" BUTTON ---
    const isAll = (store.tagFilter.size === 0);
    const allBtn = document.createElement("button");
    allBtn.className = `px-3 py-1 rounded-full text-[10px] border font-bold mr-1 ${isAll ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`;
    allBtn.innerText = "ALL";
    allBtn.onclick = () => { store.tagFilter.clear(); saveLocalSettings(); window.renderThreadList(); };
    tc.appendChild(allBtn);
    // -------------------------

    const counts=new Map(); store.threads.forEach(t=>{(t.tags||["Untagged"]).forEach(g=>counts.set(g,(counts.get(g)||0)+1))});
    [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(([t,c])=>{
        const on=store.tagFilter.has(t);
        const b=document.createElement("button"); b.className=`px-2 py-1 rounded-full text-[10px] border ${on?'bg-indigo-600 text-white border-indigo-600':'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`; b.innerText=`${t} (${c})`; 
        b.onclick=()=>{ 
            if(on) store.tagFilter.delete(t); 
            else { store.tagFilter.clear(); store.tagFilter.add(t); } 
            saveLocalSettings(); 
            window.renderThreadList(); 
        };
        tc.appendChild(b);
    });

    const el=document.getElementById("contactList"); el.innerHTML=""; 
    const s=document.getElementById("searchContacts").value.toLowerCase();

    // ============================================================
    // VIEW MODE 1: FLAT LIST (ALL)
    // ============================================================
    if (store.tagFilter.size === 0) {
        let list = store.threads.filter(t => {
            if(s && !(t.name+t.phone).toLowerCase().includes(s)) return false;
            if(store.onlyUnread && (t.unread||0)===0) return false;
            if(store.onlyPinned && !store.pinned.has(t.id)) return false;
            return true;
        });

        if(list.length === 0) { el.innerHTML = `<div class="p-4 text-center text-xs text-slate-400">No threads found.</div>`; return; }

        // Render Flat Rows
        list.forEach(t => {
            const isP = store.pinned.has(t.id);
            const unread = t.unread || 0;
            const rowBadge = unread > 0 ? `<span class="ml-2 bg-rose-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">${unread}</span>` : '';
            
            // Show first tag in pill for context
            const tagPill = (t.tags && t.tags.length > 0) 
                ? `<span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 mr-2">${t.tags[0]}</span>` 
                : '';

            el.innerHTML += `
            <div onclick="window.loadThread('${t.id}')" class="px-4 py-3 border-b border-slate-100 hover:bg-white cursor-pointer transition relative ${t.id===store.activeThreadId?'bg-indigo-50 border-indigo-100':''}">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <span class="font-bold text-sm ${unread?'text-indigo-900':''}">${escapeHtml(t.name||t.phone)}</span>
                        ${rowBadge}
                    </div>
                    <div class="flex items-center">
                        ${tagPill}
                        <i onclick="event.stopPropagation();window.togglePinThread('${t.id}')" class="fa-solid fa-star text-xs ${isP?'text-amber-400':'text-slate-200 hover:text-slate-400'}"></i>
                    </div>
                </div>
                <div class="text-xs text-slate-500 truncate flex justify-between">
                    <span class="${unread?'font-semibold text-slate-700':''}">${escapeHtml(t.lastMessageText||"No messages")}</span>
                    <span class="ml-2 opacity-70">${formatTime(t.lastMessageAtMs)}</span>
                </div>
            </div>`;
        });
        return; // Stop here, do not render groups
    }

    // ============================================================
    // VIEW MODE 2: GROUPED LIST (When Specific Tags Selected)
    // ============================================================
    const groups = {}; 

    store.threads.forEach(t => {
        let valid = true;
        if(s && !(t.name+t.phone).toLowerCase().includes(s)) valid = false;
        if(store.onlyUnread && (t.unread||0)===0) valid = false;
        if(store.onlyPinned && !store.pinned.has(t.id)) valid = false;
        if(store.tagFilter.size > 0) {
            const threadTags = t.tags || ["Untagged"];
            if (!threadTags.some(tag => store.tagFilter.has(tag))) valid = false;
        }
        if (!valid) return;

        const threadTags = (t.tags && t.tags.length) ? t.tags : ["Untagged"];
        const relevantParents = new Set();
        threadTags.forEach(tag => relevantParents.add(tag.split('-')[0].trim()));

        relevantParents.forEach(parent => {
            if (!groups[parent]) groups[parent] = { id: parent, direct: [], subs: {} };
            const relatedTags = threadTags.filter(tag => tag === parent || tag.startsWith(parent + '-'));
            const subTags = relatedTags.filter(tag => tag.includes('-') && tag.split('-').length > 1);

            if (subTags.length > 0) {
                subTags.forEach(fullTag => {
                    const subName = fullTag.split('-').slice(1).join('-').trim();
                    if (!groups[parent].subs[subName]) groups[parent].subs[subName] = [];
                    groups[parent].subs[subName].push(t);
                });
            } else {
                groups[parent].direct.push(t);
            }
        });
    });

    Object.keys(groups).sort().forEach(key => {
        const g = groups[key];
        let totalCount = g.direct.length;
        let totalUnread = 0;
        
        g.direct.forEach(t => totalUnread += (t.unread || 0));
        Object.values(g.subs).forEach(arr => {
            totalCount += arr.length;
            arr.forEach(t => totalUnread += (t.unread || 0));
        });

        if (totalCount === 0) return;
        const isOpen = store.openGroups.has(key);
        
        const btn = document.createElement("button");
        btn.onclick = () => window.toggleGroup(key);
        btn.className = "w-full text-left px-4 py-3 border-b bg-white hover:bg-slate-50 flex justify-between items-center transition group";
        
        const parentBadge = totalUnread > 0 ? `<span class="bg-rose-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm mr-1">${totalUnread}</span>` : '';

        btn.innerHTML = `
            <span class="font-bold text-sm text-slate-700">${key}</span>
            <div class="flex items-center gap-2">
                ${parentBadge}
                <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">${totalCount}</span>
                <i class="fa-solid fa-chevron-right text-slate-300 text-xs transition-transform duration-200 ${isOpen?'rotate-90':''}"></i>
            </div>`;
        el.appendChild(btn);

        if (isOpen) {
            const container = document.createElement("div");
            container.className = "bg-slate-50/50 inner-shadow-sm pb-1";

            const renderRow = (t) => {
                const isP = store.pinned.has(t.id);
                const unread = t.unread || 0;
                const rowBadge = unread > 0 ? `<span class="ml-2 bg-rose-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">${unread}</span>` : '';

                return `
                <div onclick="window.loadThread('${t.id}')" class="px-4 py-3 border-b border-slate-100 hover:bg-white cursor-pointer transition relative ${t.id===store.activeThreadId?'bg-indigo-50 border-indigo-100':''}">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <span class="font-bold text-sm ${unread?'text-indigo-900':''}">${escapeHtml(t.name||t.phone)}</span>
                            ${rowBadge}
                        </div>
                        <i onclick="event.stopPropagation();window.togglePinThread('${t.id}')" class="fa-solid fa-star text-xs ${isP?'text-amber-400':'text-slate-200 hover:text-slate-400'}"></i>
                    </div>
                    <div class="text-xs text-slate-500 truncate flex justify-between">
                        <span class="${unread?'font-semibold text-slate-700':''}">${escapeHtml(t.lastMessageText||"No messages")}</span>
                        <span class="ml-2 opacity-70">${formatTime(t.lastMessageAtMs)}</span>
                    </div>
                </div>`;
            };

            g.direct.forEach(t => { container.innerHTML += renderRow(t); });

            Object.keys(g.subs).sort().forEach(subKey => {
                const fullSubTag = `${key}-${subKey}`;
                const isSubOpen = store.openGroups.has(fullSubTag);
                const subCount = g.subs[subKey].length;
                let subUnread = 0;
                g.subs[subKey].forEach(t => subUnread += (t.unread || 0));
                const subBadge = subUnread > 0 ? `<span class="bg-rose-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm mr-1">${subUnread}</span>` : '';

                container.innerHTML += `
                    <button onclick="event.stopPropagation(); window.toggleGroup('${fullSubTag}')" class="w-full text-left px-4 py-2 bg-slate-100/50 hover:bg-slate-100 border-y border-slate-200 flex justify-between items-center transition group">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-turn-up rotate-90 text-slate-400 text-xs"></i>
                            <span class="font-bold text-xs text-slate-600 uppercase tracking-wider">${subKey}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${subBadge}
                            <span class="text-[10px] text-slate-400 bg-white border border-slate-200 px-1.5 rounded-full">${subCount}</span>
                            <i class="fa-solid fa-chevron-right text-slate-300 text-[10px] transition-transform duration-200 ${isSubOpen ? 'rotate-90' : ''}"></i>
                        </div>
                    </button>`;

                if (isSubOpen) {
                    g.subs[subKey].forEach(t => { container.innerHTML += renderRow(t); });
                }
            });
            el.appendChild(container);
        }
    });
  };

  function renderQuickReplies() {
      const r=document.getElementById("quickRepliesRow"); if(!r)return; r.innerHTML="";
      store.cannedReplies.slice(0,6).forEach(txt=>{
          const b=document.createElement("button"); b.className="px-3 py-1.5 bg-slate-100 rounded-full text-xs font-medium text-slate-600 hover:bg-slate-200 hover:text-slate-800 transition border border-transparent hover:border-slate-300"; b.innerText=txt.length>30?txt.slice(0,28)+"...":txt;
          b.onclick=()=>{ const i=document.getElementById("msgInput"); i.value+=(i.value?"\n":"")+txt; i.focus(); };
          r.appendChild(b);
      });
  }

  // CORE MSG
  // --- MMS (attachments) ---
  function updateMmsPreviewPill() {
    const pill = document.getElementById("mmsPreviewPill");
    const countEl = document.getElementById("mmsPreviewCount");
    const n = (store.pendingMedia || []).length;
    if (countEl) countEl.textContent = String(n);
    if (pill) pill.classList.toggle("hidden", n === 0);
  }

  window.handleMmsFiles = function (inp) {
    const files = Array.from(inp.files || []);
    inp.value = "";
    if (!files.length) return;
    // Twilio supports up to 10 media URLs per message
    store.pendingMedia = (store.pendingMedia || []).concat(files).slice(0, 10);
    updateMmsPreviewPill();
  };

  window.clearMmsQueue = function () {
    store.pendingMedia = [];
    updateMmsPreviewPill();
  };

  async function uploadPendingMedia(threadId) {
    const files = Array.from(store.pendingMedia || []).slice(0, 10);
    const urls = [];
    for (const file of files) {
      const safeName = (file.name || "file").replace(/[^a-zA-Z0-9._-]/g, "_");
      const path = `mms/${SHARED_ORG_ID}/${threadId}/${Date.now()}_${safeName}`;
      const r = storageRef(storage, path);
      await uploadBytes(r, file, { contentType: file.type || "application/octet-stream" });
      const url = await getDownloadURL(r);
      urls.push(url);
    }
    return urls;
  }

  function renderMedia(mediaUrls) {
    const urls = (mediaUrls || []).filter(Boolean);
    if (!urls.length) return "";
    const items = urls.map(u => {
      const esc = escapeHtml(u);
      const lower = u.toLowerCase();
      const isImg = /\.(png|jpe?g|gif|webp|bmp|svg)(\?|$)/.test(lower) || lower.includes("image");
      if (isImg) {
        return `<a href="${esc}" target="_blank" class="block"><img src="${esc}" class="mt-2 rounded-lg border max-h-64 object-contain bg-white" loading="lazy" /></a>`;
      }
      return `<a href="${esc}" target="_blank" class="mt-2 inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white text-xs text-indigo-600 hover:bg-indigo-50">
        <i class="fa-solid fa-paperclip"></i><span class="truncate max-w-[220px]">${esc}</span>
      </a>`;
    }).join("");
    return `<div class="flex flex-col">${items}</div>`;
  }


  async function upsertThread(p,n,t){ const c=normalizePhone(p); if(!c)return; await setDoc(getThreadDoc(c),{id:c,phone:p,name:n,tags:t,createdAt:serverTimestamp(),lastMessageAtMs:Date.now(),unread:0},{merge:true}); }
  async function addMessageToFirestore(threadId, body, direction, opts = {}) {
    if (!threadId) return;
    const sid = opts.sid || `loc-${Date.now()}`;
    const mediaUrls = Array.isArray(opts.mediaUrls) ? opts.mediaUrls.filter(Boolean).slice(0, 10) : [];

    await setDoc(doc(getMsgsCol(threadId), sid), {
      body: body ?? "",
      direction,
      createdAt: serverTimestamp(),
      sid,
      mediaUrls,
    }, { merge: true });

    await updateDoc(getThreadDoc(threadId), {
      lastMessageText: (body && body.trim())
        ? body
        : (mediaUrls.length ? `[${mediaUrls.length} attachment${mediaUrls.length>1?"s":""}]` : ""),
      lastMessageAtMs: Date.now(),
    });
  }

  async function sendSmsApi(to, body, mediaUrls=[]) {
    const p = new URLSearchParams();
    p.append("to", to);
    // Twilio allows empty body for some MMS, but some carriers require text; keep at least one space if only media.
    p.append("body", (body ?? "").toString());
    (mediaUrls || []).forEach(u => { if (u) p.append("mediaUrl", u); });
    await fetch(TWILIO_SEND_URL, { method: "POST", body: p });
  }
  
  window.sendMessage = async function () {
    const input = document.getElementById("msgInput");
    const text = (input?.value || "").trim();
    if ((!text && !(store.pendingMedia || []).length) || !store.activeThread) return;

    // clear UI immediately
    if (input) input.value = "";

    try {
      const threadId = store.activeThreadId;
      const to = store.activeThread.phone;

      // Upload attachments (if any) to Firebase Storage to get public HTTPS URLs for Twilio
      let mediaUrls = [];
      if ((store.pendingMedia || []).length) {
        mediaUrls = await uploadPendingMedia(threadId);
      }

      await sendSmsApi(to, text, mediaUrls);

      // Persist to Firestore so it shows in the thread instantly
      await addMessageToFirestore(threadId, text, "sent", { mediaUrls });

      // clear attachments UI
      store.pendingMedia = [];
      updateMmsPreviewPill();
      scrollToBottom();
    } catch (e) {
      console.error("Send failed", e);
      alert("Send failed (see console).");
    }
  };
  window.deleteActiveThread = async function() { if(store.activeThreadId && confirm("Delete?")) { await fetch(TWILIO_DELETE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:store.activeThread.phone})}); await deleteDoc(getThreadDoc(store.activeThreadId)); window.location.reload(); } };
  window.deleteSingleMessage = async function(tid,did,sid) { if(confirm("Delete?")) { if(sid) fetch(TWILIO_DELETE_MSG_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sid})}); await deleteDoc(doc(getMsgsCol(tid),did)); } };

  async function init() {
    loadLocalSettings();
    if(Notification.permission!=="granted") Notification.requestPermission();
    await signInAnonymously(auth);
    onAuthStateChanged(auth, u=>{ if(u){ store.uid=u.uid; unsubThreads=onSnapshot(query(getThreadsCol()), s=>{ store.threads=[]; s.forEach(d=>store.threads.push(d.data())); window.renderThreadList(); }); setInterval(pollIncomingMessages, 10000); } });
    const inp=document.getElementById("msgInput");
    inp.addEventListener("input", ()=>{ inp.style.height='auto';inp.style.height=inp.scrollHeight+'px'; if(store.activeThreadId){ store.drafts[store.activeThreadId]=inp.value; saveLocalSettings(); document.getElementById("draftHint").classList.remove("opacity-0"); setTimeout(()=>document.getElementById("draftHint").classList.add("opacity-0"),1000); } });
    inp.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); window.sendMessage(); } });
    renderQuickReplies();
    updateMmsPreviewPill();
  }
  init();
</script>
</body>
</html>
